import{j as De,k as Ee,o as N,n as k,q as Oe,y as e,f as q,v as l,w as r,H as ae,a as m,A as je,B as o,x as M,C as w,h as Fe,G as Le,m as $e}from"./disclose-version-CnRXLrRc.js";import{i as x,b as se,e as Ie,Q as Ne,s as re,a as Me,S as Pe}from"./index-Da1Pd0J_.js";const le=[...` 	
\r\f¬†\v\uFEFF`];function Te(z,P,i){var s=""+z;if(i){for(var u in i)if(i[u])s=s?s+" "+u:u;else if(s.length)for(var d=u.length,c=0;(c=s.indexOf(u,c))>=0;){var n=c+d;(c===0||le.includes(s[c-1]))&&(n===s.length||le.includes(s[n]))?s=(c===0?"":s.substring(0,c))+s.substring(n+1):c=n}}return s===""?null:s}function Be(z,P,i,s,u,d){var c=z.__className;if(c!==i||c===void 0){var n=Te(i,s,d);n==null?z.removeAttribute("class"):z.className=n,z.__className=i}else if(d&&u!==d)for(var C in d){var p=!!d[C];(u==null||p!==!!u[C])&&z.classList.toggle(C,p)}return d}var Ge=q('<button class="primary svelte-l4z3uq">üì∑ Start Scanning</button>'),Je=q('<button class="danger svelte-l4z3uq">‚èπ Stop Scanning</button>'),Ve=q('<div class="scanner-view svelte-l4z3uq"><video autoplay playsinline="" class="svelte-l4z3uq"></video> <canvas style="display:none;"></canvas> <div class="scanner-overlay svelte-l4z3uq"><div class="scanner-frame svelte-l4z3uq"></div></div></div>',2),We=q("<div></div>"),Ke=q('<div class="success-message svelte-l4z3uq">‚úì All chunks have been received!</div>'),Xe=q('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">2. Reception Progress</h2> <div class="file-info"><p class="svelte-l4z3uq"><strong>Fichier:</strong> </p> <p class="svelte-l4z3uq"><strong>Hash:</strong> <code class="svelte-l4z3uq"> </code></p></div> <div class="progress-section svelte-l4z3uq"><p class="progress-text svelte-l4z3uq"> </p> <div class="chunks-grid svelte-l4z3uq"></div></div> <div class="stats svelte-l4z3uq"><div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Total scanned:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Duplicates:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Errors:</span> <span class="stat-value svelte-l4z3uq"> </span></div></div> <!></div>'),Ye=q('<div class="recovery-section svelte-l4z3uq"><p class="info svelte-l4z3uq"><strong> </strong> <!></p> <div class="qr-display svelte-l4z3uq"><img alt="QR Code de r√©cup√©ration" class="svelte-l4z3uq"/> <p class="qr-caption svelte-l4z3uq">Scan this QR with the sender page to retransmit missing chunks</p></div></div>'),Ze=q(`<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">3. Missing chunks recovery</h2> <p class="svelte-l4z3uq">If chunks are missing, generate a recovery QR code to scan with the
          sender.</p> <button class="svelte-l4z3uq">üîÑ Generate Recovery QR</button> <!></div>`),et=q('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">4. Download file</h2> <button class="download-button svelte-l4z3uq"> </button></div>'),tt=q('<main class="svelte-l4z3uq"><header class="card svelte-l4z3uq"><h1 class="svelte-l4z3uq">üì• QR Code Receiver</h1> <div class="controls svelte-l4z3uq"><!> <button class="secondary svelte-l4z3uq">üîÑ Reset</button></div></header> <section class="main-content svelte-l4z3uq"><!> <!></section> <footer class="card svelte-l4z3uq"><!> <!></footer></main>');function at(z,P){Ee(P,!0);let i,s,u,d=k(!1),c=N(new Map),n=k(null),C=k(""),p=k(""),g=k(0),E=k(0),R=k(N([])),ne=k(N(Date.now())),S=k(N({totalScanned:0,duplicates:0,errors:0})),ie=ae(()=>e(g)>0?e(E)/e(g)*100:0),T=ae(()=>e(g)>0&&e(E)===e(g));async function oe(){if(o(d,!0),await Fe(),!i){alert("Video element not ready. Please try again."),o(d,!1);return}if(s&&!u&&(u=s.getContext("2d",{willReadFrequently:!0})),!u){alert("Canvas not ready. Please try again."),o(d,!1);return}try{const a=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});i.srcObject=a,i.play(),requestAnimationFrame(J)}catch(a){console.error("Camera access error:",a),alert("Unable to access camera. Please allow camera access."),o(d,!1)}}function F(){o(d,!1),i&&i.srcObject&&(i.srcObject.getTracks().forEach(a=>a.stop()),i.srcObject=null)}async function J(){if(!(!e(d)||!u)){if(i.readyState===i.HAVE_ENOUGH_DATA){s.height=i.videoHeight,s.width=i.videoWidth,u.drawImage(i,0,0,s.width,s.height);const a=u.getImageData(0,0,s.width,s.height);try{const t=await Pe(a);if(t&&t.length>0)for(const f of t){const h=f.decode();h&&h.length>0&&ce(h)}}catch(t){console.error("Erreur de scan zbar:",t)}}requestAnimationFrame(J)}}function ce(a){console.log("QR code data received:",a),e(S).totalScanned++;try{const t=JSON.parse(a);if(t.type==="fileInfo"){e(n)||(o(n,{hash:t.fileHash,name:t.fileName,size:t.fileSize},!0),o(g,t.totalChunks,!0),console.log("File info received:",e(n)));return}if(!t.fileHash||t.chunkIndex===void 0||!t.data){e(S).errors++;return}if(e(n)||(o(n,{hash:t.fileHash,name:t.fileName,totalChunks:t.totalChunks},!0),o(g,t.totalChunks,!0)),t.fileHash!==e(n).hash){console.warn("Chunk d'un autre fichier d√©tect√©");return}if(c.has(t.chunkIndex)){e(S).duplicates++;return}c.set(t.chunkIndex,t.data),o(E,c.size,!0),o(ne,Date.now(),!0),console.log(`Chunk ${t.chunkIndex+1}/${e(g)} re√ßu`),e(E)===e(g)&&ve()}catch(t){e(S).errors++,console.error("Erreur de traitement du QR code:",t)}}async function ve(){console.log("Assemblage du fichier...");try{const a=[];for(let v=0;v<e(g);v++){if(!c.has(v)){console.error(`Chunk ${v} manquant`);return}a.push(c.get(v))}const t=a.map(v=>{const b=atob(v),O=new Uint8Array(b.length);for(let y=0;y<b.length;y++)O[y]=b.charCodeAt(y);return O}),f=t.reduce((v,b)=>v+b.length,0),h=new Uint8Array(f);let _=0;for(const v of t)h.set(v,_),_+=v.length;const A=await crypto.subtle.digest("SHA-256",h),H=Array.from(new Uint8Array(A)).map(v=>v.toString(16).padStart(2,"0")).join("");if(H!==e(n).hash){alert("‚ö† Erreur: Le hash du fichier ne correspond pas !"),console.error("Hash attendu:",e(n).hash),console.error("Hash calcul√©:",H);return}const Q=new Blob([h]);o(p,URL.createObjectURL(Q),!0),console.log("‚úì Fichier assembl√© avec succ√®s !"),F()}catch(a){console.error("Erreur lors de l'assemblage du fichier:",a),alert("Erreur lors de l'assemblage du fichier")}}async function ue(){o(R,[],!0);for(let t=0;t<e(g);t++)c.has(t)||e(R).push(t);if(e(R).length===0){alert("All chunks have been received!");return}const a={type:"recovery",fileHash:e(n).hash,missingChunks:e(R)};try{o(C,await Ne.toDataURL(JSON.stringify(a),{errorCorrectionLevel:"M",margin:1,width:400}),!0)}catch(t){console.error("Erreur lors de la g√©n√©ration du QR de r√©cup√©ration:",t)}}function de(){if(!e(p))return;const a=document.createElement("a");a.href=e(p),a.download=e(n).name||"fichier_recu",document.body.appendChild(a),a.click(),document.body.removeChild(a)}function he(){F(),c.clear(),o(n,null),o(C,""),o(p,""),o(g,0),o(E,0),o(R,[],!0),o(S,{totalScanned:0,duplicates:0,errors:0},!0),e(p)&&URL.revokeObjectURL(e(p))}Oe(()=>(s&&(u=s.getContext("2d",{willReadFrequently:!0})),()=>{F(),e(p)&&URL.revokeObjectURL(e(p))}));var V=tt(),W=r(V),fe=l(r(W),2),K=r(fe);{var ge=a=>{var t=Ge();t.__click=oe,m(a,t)},pe=a=>{var t=Je();t.__click=F,m(a,t)};x(K,a=>{e(d)?a(pe,!1):a(ge)})}var me=l(K,2);me.__click=he;var X=l(W,2),Y=r(X);{var _e=a=>{var t=Ve(),f=r(t);se(f,_=>i=_,()=>i);var h=l(f,2);se(h,_=>s=_,()=>s),m(a,t)};x(Y,a=>{e(d)&&a(_e)})}var be=l(Y,2);{var qe=a=>{var t=Xe(),f=l(r(t),2),h=r(f),_=l(r(h)),A=l(h,2),j=l(r(A),2),H=r(j),Q=l(f,2),v=r(Q),b=r(v),O=l(v,2);Ie(O,21,()=>Array(e(g)),Me,(D,I,ee)=>{var G=We();let te;M(Ue=>{te=Be(G,1,"chunk-box svelte-l4z3uq",null,te,Ue),re(G,"title",`Chunk ${ee+1}/${e(g)??""}`)},[()=>({received:c.has(ee)})]),m(D,G)});var y=l(Q,2),L=r(y),B=l(r(L),2),U=r(B),$=l(L,2),Ce=l(r($),2),Re=r(Ce),Se=l($,2),xe=l(r(Se),2),Ae=r(xe),He=l(y,2);{var Qe=D=>{var I=Ke();m(D,I)};x(He,D=>{e(T)&&D(Qe)})}M((D,I)=>{w(_,` ${e(n).name??""}`),w(H,`${D??""}...`),w(b,`${e(E)??""} / ${e(g)??""} chunks received (${I??""}%)`),w(U,e(S).totalScanned),w(Re,e(S).duplicates),w(Ae,e(S).errors)},[()=>e(n).hash.substring(0,16),()=>e(ie).toFixed(1)]),m(a,t)};x(be,a=>{e(n)&&a(qe)})}var ze=l(X,2),Z=r(ze);{var ye=a=>{var t=Ze(),f=l(r(t),4);f.__click=ue;var h=l(f,2);{var _=A=>{var j=Ye(),H=r(j),Q=r(H),v=r(Q),b=l(Q),O=l(b);{var y=U=>{var $=Le("...");m(U,$)};x(O,U=>{e(R).length>10&&U(y)})}var L=l(H,2),B=r(L);M(U=>{w(v,e(R).length),w(b,` missing chunk(s):
              ${U??""} `),re(B,"src",e(C))},[()=>e(R).slice(0,10).join(", ")]),m(A,j)};x(h,A=>{e(C)&&A(_)})}m(a,t)};x(Z,a=>{e(n)&&!e(T)&&a(ye)})}var ke=l(Z,2);{var we=a=>{var t=et(),f=l(r(t),2);f.__click=de;var h=r(f);M(()=>w(h,`üíæ Download ${e(n).name??""}`)),m(a,t)};x(ke,a=>{e(T)&&e(p)&&a(we)})}m(z,V),je()}De(["click"]);$e(at,{target:document.body});
