import{j as Ee,k as Oe,o as N,n as R,q as Fe,y as e,f as q,v as a,w as r,H as ae,a as y,A as Le,B as u,x as B,C as S,h as $e,G as Ie,m as Ne}from"./disclose-version-UNGnYCer.js";import{i as A,b as ne,e as Be,Q as Me,s as le,a as Te,S as Pe}from"./index-B2xt4Leg.js";const oe=[...` 	
\r\f¬†\v\uFEFF`];function Ge(z,M,k){var h=""+z;if(k){for(var n in k)if(k[n])h=h?h+" "+n:n;else if(h.length)for(var l=n.length,i=0;(i=h.indexOf(n,i))>=0;){var g=i+l;(i===0||oe.includes(h[i-1]))&&(g===h.length||oe.includes(h[g]))?h=(i===0?"":h.substring(0,i))+h.substring(g+1):i=g}}return h===""?null:h}function Je(z,M,k,h,n,l){var i=z.__className;if(i!==k||i===void 0){var g=Ge(k,h,l);g==null?z.removeAttribute("class"):z.className=g,z.__className=k}else if(l&&n!==l)for(var _ in l){var d=!!l[_];(n==null||d!==!!n[_])&&z.classList.toggle(_,d)}return l}var Ve=q('<button class="primary svelte-l4z3uq">üì∑ Start Scanning</button>'),We=q('<button class="danger svelte-l4z3uq">‚èπ Stop Scanning</button>'),Ke=q('<div class="scanner-view svelte-l4z3uq"><video autoplay playsinline="" class="svelte-l4z3uq"></video> <canvas style="display:none;"></canvas> <div class="scanner-overlay svelte-l4z3uq"><div class="scanner-frame svelte-l4z3uq"></div></div></div>',2),Xe=q("<div></div>"),Ye=q('<div class="success-message svelte-l4z3uq">‚úì All chunks have been received!</div>'),Ze=q('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">2. Reception Progress</h2> <div class="file-info"><p class="svelte-l4z3uq"><strong>Fichier:</strong> </p> <p class="svelte-l4z3uq"><strong>Hash:</strong> <code class="svelte-l4z3uq"> </code></p></div> <div class="progress-section svelte-l4z3uq"><p class="progress-text svelte-l4z3uq"> </p> <div class="chunks-grid svelte-l4z3uq"></div></div> <div class="stats svelte-l4z3uq"><div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Total scanned:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Duplicates:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Errors:</span> <span class="stat-value svelte-l4z3uq"> </span></div></div> <!></div>'),et=q('<div class="recovery-section svelte-l4z3uq"><p class="info svelte-l4z3uq"><strong> </strong> <!></p> <div class="qr-display svelte-l4z3uq"><img alt="QR Code de r√©cup√©ration" class="svelte-l4z3uq"/> <p class="qr-caption svelte-l4z3uq">Scan this QR with the sender page to retransmit missing chunks</p></div></div>'),tt=q(`<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">3. Missing chunks recovery</h2> <p class="svelte-l4z3uq">If chunks are missing, generate a recovery QR code to scan with the
          sender.</p> <button class="svelte-l4z3uq">üîÑ Generate Recovery QR</button> <!></div>`),st=q('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">4. Download file</h2> <button class="download-button svelte-l4z3uq"> </button></div>'),rt=q('<main class="svelte-l4z3uq"><header class="card svelte-l4z3uq"><h1 class="svelte-l4z3uq">üì• QR Code Receiver</h1> <div class="controls svelte-l4z3uq"><!> <button class="secondary svelte-l4z3uq">üîÑ Reset</button></div></header> <section class="main-content svelte-l4z3uq"><!> <!></section> <footer class="card svelte-l4z3uq"><!> <!></footer></main>');function at(z,M){Oe(M,!0);function k(t){return Array.from(t).map(s=>s.toString(16).padStart(2,"0")).join("")}function h(t){return t<=255?1:t<=65535?2:3}let n,l,i,g=R(!1),_=N(new Map),d=R(null),O=R(""),w=R(""),p=R(0),j=R(0),x=R(N([])),ie=R(N(Date.now())),C=R(N({totalScanned:0,duplicates:0,errors:0})),ce=ae(()=>e(p)>0?e(j)/e(p)*100:0),T=ae(()=>e(p)>0&&e(j)===e(p));async function ve(){if(u(g,!0),await $e(),!n){alert("Video element not ready. Please try again."),u(g,!1);return}if(l&&!i&&(i=l.getContext("2d",{willReadFrequently:!0})),!i){alert("Canvas not ready. Please try again."),u(g,!1);return}try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});n.srcObject=t,n.play(),requestAnimationFrame(V)}catch(t){console.error("Camera access error:",t),alert("Unable to access camera. Please allow camera access."),u(g,!1)}}function F(){u(g,!1),n&&n.srcObject&&(n.srcObject.getTracks().forEach(t=>t.stop()),n.srcObject=null)}async function V(){if(!(!e(g)||!i)){if(n.readyState===n.HAVE_ENOUGH_DATA){l.height=n.videoHeight,l.width=n.videoWidth,i.drawImage(n,0,0,l.width,l.height);const t=i.getImageData(0,0,l.width,l.height);try{const s=await Pe(t);if(s&&s.length>0){console.log("symbols detected:",s);for(const m of s){const c=m.decode();c&&c.length>0&&ue(c)}}}catch(s){console.error("Erreur de scan zbar:",s)}}requestAnimationFrame(V)}}function ue(t){console.log("QR code data received, type:",typeof t,"length:",t.length),e(C).totalScanned++;try{if(typeof t=="string")try{const o=JSON.parse(t);if(o.type==="fileInfo"){e(d)||(u(d,{hash:o.fileHash,name:o.fileName,size:o.fileSize},!0),u(p,o.totalChunks,!0),console.log("File info received:",e(d)));return}}catch{}if(!e(d)||!e(p)){console.log("Waiting for file info QR code first...");return}let s;if(typeof t=="string"){s=new Uint8Array(t.length);for(let o=0;o<t.length;o++)s[o]=t.charCodeAt(o)&255}else s=t;if(s.length<21){e(C).errors++,console.error("Chunk trop petit:",s.length);return}if(k(s.slice(0,20))!==e(d).hash){console.warn("Chunk d'un autre fichier d√©tect√©");return}const c=h(e(p));let v=0;for(let o=0;o<c;o++)v=v<<8|s[20+o];if(v<0||v>=e(p)){e(C).errors++,console.error("Index de chunk invalide:",v);return}if(_.has(v)){e(C).duplicates++;return}const b=s.slice(20+c);_.set(v,b),u(j,_.size,!0),u(ie,Date.now(),!0),console.log(`Chunk ${v+1}/${e(p)} re√ßu (${b.length} bytes)`),e(j)===e(p)&&de()}catch(s){e(C).errors++,console.error("Erreur de traitement du QR code:",s)}}async function de(){console.log("Assemblage du fichier...");try{const t=[];for(let f=0;f<e(p);f++){if(!_.has(f)){console.error(`Chunk ${f} manquant`);return}t.push(_.get(f))}const s=t,m=s.reduce((f,E)=>f+E.length,0),c=new Uint8Array(m);let v=0;for(const f of s)c.set(f,v),v+=f.length;const b=await crypto.subtle.digest("SHA-1",c),Q=Array.from(new Uint8Array(b)).map(f=>f.toString(16).padStart(2,"0")).join("");if(Q!==e(d).hash){alert("‚ö† Erreur: Le hash du fichier ne correspond pas !"),console.error("Hash attendu:",e(d).hash),console.error("Hash calcul√©:",Q);return}const D=new Blob([c]);u(w,URL.createObjectURL(D),!0),console.log("‚úì Fichier assembl√© avec succ√®s !"),F()}catch(t){console.error("Erreur lors de l'assemblage du fichier:",t),alert("Erreur lors de l'assemblage du fichier")}}async function he(){u(x,[],!0);for(let s=0;s<e(p);s++)_.has(s)||e(x).push(s);if(e(x).length===0){alert("All chunks have been received!");return}const t={type:"recovery",fileHash:e(d).hash,missingChunks:e(x)};try{u(O,await Me.toDataURL(JSON.stringify(t),{errorCorrectionLevel:"M",margin:1,width:400}),!0)}catch(s){console.error("Erreur lors de la g√©n√©ration du QR de r√©cup√©ration:",s)}}function fe(){if(!e(w))return;const t=document.createElement("a");t.href=e(w),t.download=e(d).name||"fichier_recu",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function ge(){F(),_.clear(),u(d,null),u(O,""),u(w,""),u(p,0),u(j,0),u(x,[],!0),u(C,{totalScanned:0,duplicates:0,errors:0},!0),e(w)&&URL.revokeObjectURL(e(w))}Fe(()=>(l&&(i=l.getContext("2d",{willReadFrequently:!0})),()=>{F(),e(w)&&URL.revokeObjectURL(e(w))}));var W=rt(),K=r(W),pe=a(r(K),2),X=r(pe);{var me=t=>{var s=Ve();s.__click=ve,y(t,s)},_e=t=>{var s=We();s.__click=F,y(t,s)};A(X,t=>{e(g)?t(_e,!1):t(me)})}var ye=a(X,2);ye.__click=ge;var Y=a(K,2),Z=r(Y);{var be=t=>{var s=Ke(),m=r(s);ne(m,v=>n=v,()=>n);var c=a(m,2);ne(c,v=>l=v,()=>l),y(t,s)};A(Z,t=>{e(g)&&t(be)})}var qe=a(Z,2);{var ze=t=>{var s=Ze(),m=a(r(s),2),c=r(m),v=a(r(c)),b=a(c,2),o=a(r(b),2),Q=r(o),D=a(m,2),f=r(D),E=r(f),P=a(f,2);Be(P,21,()=>Array(e(p)),Te,(U,te,se)=>{var J=Xe();let re;B(je=>{re=Je(J,1,"chunk-box svelte-l4z3uq",null,re,je),le(J,"title",`Chunk ${se+1}/${e(p)??""}`)},[()=>({received:_.has(se)})]),y(U,J)});var L=a(D,2),$=r(L),G=a(r($),2),H=r(G),I=a($,2),Se=a(r(I),2),xe=r(Se),Ae=a(I,2),Qe=a(r(Ae),2),De=r(Qe),He=a(L,2);{var Ue=U=>{var te=Ye();y(U,te)};A(He,U=>{e(T)&&U(Ue)})}B(U=>{S(v,` ${e(d).name??""}`),S(Q,e(d).hash.substring),S(E,`${e(j)??""} / ${e(p)??""} chunks received (${U??""}%)`),S(H,e(C).totalScanned),S(xe,e(C).duplicates),S(De,e(C).errors)},[()=>e(ce).toFixed(1)]),y(t,s)};A(qe,t=>{e(d)&&t(ze)})}var ke=a(Y,2),ee=r(ke);{var we=t=>{var s=tt(),m=a(r(s),4);m.__click=he;var c=a(m,2);{var v=b=>{var o=et(),Q=r(o),D=r(Q),f=r(D),E=a(D),P=a(E);{var L=H=>{var I=Ie("...");y(H,I)};A(P,H=>{e(x).length>10&&H(L)})}var $=a(Q,2),G=r($);B(H=>{S(f,e(x).length),S(E,` missing chunk(s):
              ${H??""} `),le(G,"src",e(O))},[()=>e(x).slice(0,10).join(", ")]),y(b,o)};A(c,b=>{e(O)&&b(v)})}y(t,s)};A(ee,t=>{e(d)&&!e(T)&&t(we)})}var Ce=a(ee,2);{var Re=t=>{var s=st(),m=a(r(s),2);m.__click=fe;var c=r(m);B(()=>S(c,`üíæ Download ${e(d).name??""}`)),y(t,s)};A(Ce,t=>{e(T)&&e(w)&&t(Re)})}y(z,W),Le()}Ee(["click"]);Ne(at,{target:document.body});
