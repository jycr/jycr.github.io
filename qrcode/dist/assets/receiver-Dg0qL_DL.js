import{j as Ee,k as Oe,o as L,n as S,q as je,y as t,f as y,v as n,w as r,H as Fe,a as m,A as He,B as h,x as N,C as w,h as Ie,G as $e,m as Le}from"./disclose-version-UNGnYCer.js";import{i as x,b as se,e as Ne,Q as Te,s as re,a as Be,S as Me}from"./index-B2xt4Leg.js";const ne=[...` 	
\r\f¬†\v\uFEFF`];function Je(q,T,z){var d=""+q;if(z){for(var l in z)if(z[l])d=d?d+" "+l:l;else if(d.length)for(var o=l.length,c=0;(c=d.indexOf(l,c))>=0;){var f=c+o;(c===0||ne.includes(d[c-1]))&&(f===d.length||ne.includes(d[f]))?d=(c===0?"":d.substring(0,c))+d.substring(f+1):c=f}}return d===""?null:d}function Pe(q,T,z,d,l,o){var c=q.__className;if(c!==z||c===void 0){var f=Je(z,d,o);f==null?q.removeAttribute("class"):q.className=f,q.__className=z}else if(o&&l!==o)for(var _ in o){var s=!!o[_];(l==null||s!==!!l[_])&&q.classList.toggle(_,s)}return o}var Ge=y('<button class="primary svelte-l4z3uq">üì∑ Start Scanning</button>'),Ve=y('<button class="danger svelte-l4z3uq">‚èπ Stop Scanning</button>'),We=y('<div class="scanner-view svelte-l4z3uq"><video autoplay playsinline="" class="svelte-l4z3uq"></video> <canvas style="display:none;"></canvas> <div class="scanner-overlay svelte-l4z3uq"><div class="scanner-frame svelte-l4z3uq"></div></div></div>',2),Ke=y("<div></div>"),Xe=y('<div class="success-message svelte-l4z3uq">‚úì All chunks have been received!</div>'),Ye=y('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">2. Reception Progress</h2> <div class="file-info"><p class="svelte-l4z3uq"><strong>Fichier:</strong> </p> <p class="svelte-l4z3uq"><strong>Hash:</strong> <code class="svelte-l4z3uq"> </code></p></div> <div class="progress-section svelte-l4z3uq"><p class="progress-text svelte-l4z3uq"> </p> <div class="chunks-grid svelte-l4z3uq"></div></div> <div class="stats svelte-l4z3uq"><div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Total scanned:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Duplicates:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Errors:</span> <span class="stat-value svelte-l4z3uq"> </span></div></div> <!></div>'),Ze=y('<div class="recovery-section svelte-l4z3uq"><p class="info svelte-l4z3uq"><strong> </strong> <!></p> <div class="qr-display svelte-l4z3uq"><img alt="QR Code de r√©cup√©ration" class="svelte-l4z3uq"/> <p class="qr-caption svelte-l4z3uq">Scan this QR with the sender page to retransmit missing chunks</p></div></div>'),et=y(`<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">3. Missing chunks recovery</h2> <p class="svelte-l4z3uq">If chunks are missing, generate a recovery QR code to scan with the
          sender.</p> <button class="svelte-l4z3uq">üîÑ Generate Recovery QR</button> <!></div>`),tt=y('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">4. Download file</h2> <button class="download-button svelte-l4z3uq"> </button></div>'),at=y('<main class="svelte-l4z3uq"><header class="card svelte-l4z3uq"><h1 class="svelte-l4z3uq">üì• QR Code Receiver</h1> <div class="controls svelte-l4z3uq"><!> <button class="secondary svelte-l4z3uq">üîÑ Reset</button></div></header> <section class="main-content svelte-l4z3uq"><!> <!></section> <footer class="card svelte-l4z3uq"><!> <!></footer></main>');function st(q,T){Oe(T,!0);function z(e){return Array.from(e).map(a=>a.toString(16).padStart(2,"0")).join("")}function d(e){return e<=255?1:e<=65535?2:3}let l,o,c,f=S(!1),_=L(new Map),s=S(null),O=S(""),b=S(""),Q=S(0),R=S(L([])),le=S(L(Date.now())),k=S(L({totalScanned:0,duplicates:0,errors:0})),B=Fe(()=>t(s)&&t(Q)===t(s).totalChunks);async function oe(){if(h(f,!0),await Ie(),!l){alert("Video element not ready. Please try again."),h(f,!1);return}if(o&&!c&&(c=o.getContext("2d",{willReadFrequently:!0})),!c){alert("Canvas not ready. Please try again."),h(f,!1);return}try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});l.srcObject=e,l.play(),requestAnimationFrame(G)}catch(e){console.error("Camera access error:",e),alert("Unable to access camera. Please allow camera access."),h(f,!1)}}function j(){h(f,!1),l&&l.srcObject&&(l.srcObject.getTracks().forEach(e=>e.stop()),l.srcObject=null)}async function G(){if(!(!t(f)||!c)){if(l.readyState===l.HAVE_ENOUGH_DATA){o.height=l.videoHeight,o.width=l.videoWidth,c.drawImage(l,0,0,o.width,o.height);const e=c.getImageData(0,0,o.width,o.height);try{const a=await Me(e);if(a&&a.length>0){console.log("symbols detected:",a);for(const i of a)i?.data.length>0&&ce(i)}}catch(a){console.error("Erreur de scan zbar:",a)}}requestAnimationFrame(G)}}const ie=123;function ce(e){if(e.data[0]===ie)try{const a=JSON.parse(e.decode());if(a.type==="fileInfo"){h(s,{hash:a.fileHash,name:a.fileName,size:a.fileSize,totalChunks:a.totalChunks},!0),console.log("File info received:",t(s));return}else{console.warn("Unknown JSON QR code type:",a.type);return}}catch{}t(k).totalScanned++;try{if(!t(s)){console.log("Waiting for file info QR code first...");return}let a;if(e.data instanceof Int8Array){a=new Uint8Array(e.data.length);for(let g=0;g<e.data.length;g++)a[g]=e.data[g]&255}else if(e.data instanceof Uint8Array)a=e.data;else{console.error("Invalid symbol data type");return}if(a.length<21){t(k).errors++,console.error("Chunk too short:",a.length);return}const i=z(a.slice(0,20));if(i!==t(s).hash){console.warn("Chunk hash does not match file hash:",i,"expected:",t(s).hash);return}const p=d(t(s).totalChunks);let v=0;for(let g=0;g<p;g++)v=v<<8|a[20+g];if(v<0||v>=t(s).totalChunks){t(k).errors++,console.error("Invalid chunk index:",v);return}if(_.has(v)){t(k).duplicates++;return}const C=a.slice(20+p);_.set(v,C),h(Q,_.size,!0),h(le,Date.now(),!0),console.log(`Received chunk ${v+1}/${t(s).totalChunks} (${C.length} bytes)`),t(Q)===t(s).totalChunks&&(j(),ve())}catch(a){t(k).errors++,console.error("Error processing QR code:",a)}}async function ve(){console.log("Assembling file...");try{const e=[];for(let u=0;u<t(s).totalChunks;u++){if(!_.has(u)){console.error(`missing chunk: ${u}`);return}e.push(_.get(u))}const a=e.reduce((u,E)=>u+E.length,0),i=new Uint8Array(a);let p=0;for(const u of e)i.set(u,p),p+=u.length;const v=await crypto.subtle.digest("SHA-1",i),g=Array.from(new Uint8Array(v)).map(u=>u.toString(16).padStart(2,"0")).join("");if(g!==t(s).hash){alert("‚ö† Error: File hash does not match!"),console.error("Expected hash:",t(s).hash),console.error("Calculated hash:",g);return}const D=new Blob([i]);h(b,URL.createObjectURL(D),!0),console.log("‚úì File assembled successfully!")}catch(e){console.error("Error assembling file:",e),alert("Error assembling file: "+e.message)}}async function ue(){h(R,[],!0);for(let a=0;a<t(s).totalChunks;a++)_.has(a)||t(R).push(a);if(t(R).length===0){alert("All chunks have been received!");return}const e={type:"recovery",fileHash:t(s).hash,missingChunks:t(R)};try{h(O,await Te.toDataURL(JSON.stringify(e),{errorCorrectionLevel:"M",margin:1,width:400}),!0)}catch(a){console.error("Erreur lors de la g√©n√©ration du QR de r√©cup√©ration:",a)}}function de(){if(!t(b))return;const e=document.createElement("a");e.href=t(b),e.download=t(s).name||"fichier_recu",document.body.appendChild(e),e.click(),document.body.removeChild(e)}function he(){j(),_.clear(),h(s,null),h(O,""),h(b,""),h(Q,0),h(R,[],!0),h(k,{totalScanned:0,duplicates:0,errors:0},!0),t(b)&&URL.revokeObjectURL(t(b))}je(()=>(o&&(c=o.getContext("2d",{willReadFrequently:!0})),()=>{j(),t(b)&&URL.revokeObjectURL(t(b))}));var V=at(),W=r(V),fe=n(r(W),2),K=r(fe);{var ge=e=>{var a=Ge();a.__click=oe,m(e,a)},pe=e=>{var a=Ve();a.__click=j,m(e,a)};x(K,e=>{t(f)?e(pe,!1):e(ge)})}var _e=n(K,2);_e.__click=he;var X=n(W,2),Y=r(X);{var me=e=>{var a=We(),i=r(a);se(i,v=>l=v,()=>l);var p=n(i,2);se(p,v=>o=v,()=>o),m(e,a)};x(Y,e=>{t(f)&&e(me)})}var ye=n(Y,2);{var qe=e=>{var a=Ye(),i=n(r(a),2),p=r(i),v=n(r(p)),C=n(p,2),g=n(r(C),2),D=r(g),u=n(i,2),E=r(u),F=r(E),M=n(E,2);Ne(M,21,()=>Array(t(s).totalChunks),Be,(U,ee,te)=>{var P=Ke();let ae;N(De=>{ae=Pe(P,1,"chunk-box svelte-l4z3uq",null,ae,De),re(P,"title",`Chunk ${te+1}/${t(s).totalChunks??""}`)},[()=>({received:_.has(te)})]),m(U,P)});var H=n(u,2),I=r(H),J=n(r(I),2),A=r(J),$=n(I,2),we=n(r($),2),Re=r(we),Se=n($,2),xe=n(r(Se),2),Ae=r(xe),Ue=n(H,2);{var Qe=U=>{var ee=Xe();m(U,ee)};x(Ue,U=>{t(B)&&U(Qe)})}N(U=>{w(v,` ${t(s).name??""}`),w(D,t(s).hash),w(F,`${t(Q)??""} / ${t(s).totalChunks??""} chunks received (${U??""}%)`),w(A,t(k).totalScanned),w(Re,t(k).duplicates),w(Ae,t(k).errors)},[()=>(t(Q)/t(s).totalChunks*100).toFixed(1)]),m(e,a)};x(ye,e=>{t(s)&&e(qe)})}var ze=n(X,2),Z=r(ze);{var be=e=>{var a=et(),i=n(r(a),4);i.__click=ue;var p=n(i,2);{var v=C=>{var g=Ze(),D=r(g),u=r(D),E=r(u),F=n(u),M=n(F);{var H=A=>{var $=$e("...");m(A,$)};x(M,A=>{t(R).length>10&&A(H)})}var I=n(D,2),J=r(I);N(A=>{w(E,t(R).length),w(F,` missing chunk(s):
              ${A??""} `),re(J,"src",t(O))},[()=>t(R).slice(0,10).join(", ")]),m(C,g)};x(p,C=>{t(O)&&C(v)})}m(e,a)};x(Z,e=>{t(s)&&!t(B)&&e(be)})}var ke=n(Z,2);{var Ce=e=>{var a=tt(),i=n(r(a),2);i.__click=de;var p=r(i);N(()=>w(p,`üíæ Download ${t(s).name??""}`)),m(e,a)};x(ke,e=>{t(B)&&t(b)&&e(Ce)})}m(q,V),He()}Ee(["click"]);Le(st,{target:document.body});
