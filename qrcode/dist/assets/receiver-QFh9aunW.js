import{j as Ae,k as $e,n as R,o as J,q as Ue,y as e,f as m,v as i,w as o,H as Qe,a as g,A as Fe,B as f,x as B,C as k,h as Ee,G as He,m as Ne}from"./disclose-version-UNGnYCer.js";import{n as Oe,o as Be,b as re,p as De,q as Te,i as z,d as ee,e as Le,r as je,a as te,c as Je,f as se,h as Me,m as Pe,l as Ge}from"./scannerService-DbcQiDd2.js";const ae=[...` 	
\r\f¬†\v\uFEFF`];function Ve(l,v,s){var n=""+l;if(s){for(var c in s)if(s[c])n=n?n+" "+c:c;else if(n.length)for(var d=c.length,t=0;(t=n.indexOf(c,t))>=0;){var p=t+d;(t===0||ae.includes(n[t-1]))&&(p===n.length||ae.includes(n[p]))?n=(t===0?"":n.substring(0,t))+n.substring(p+1):t=p}}return n===""?null:n}function We(l,v,s,n,c,d){var t=l.__className;if(t!==s||t===void 0){var p=Ve(s,n,d);p==null?l.removeAttribute("class"):l.className=p,l.__className=s}else if(d&&c!==d)for(var h in d){var u=!!d[h];(c==null||u!==!!c[h])&&l.classList.toggle(h,u)}return d}function Ie(l){if(l.data[0]!==123)throw new Error("Data is not JSON");const s=JSON.parse(l.decode());if(s.type!=="fileInfo")throw new Error(`Unknown JSON QR code type: ${s.type}`);const n=Oe(s.totalChunks);return{hash:s.fileHash,name:s.fileName,size:s.fileSize,totalChunks:s.totalChunks,indexBytes:n,chunks:[],receivedCount:0}}function Ke(l,v){let s;l.data instanceof Int8Array?s=Be(l.data):s=new Uint8Array(l.data);const n=re(s.slice(0,20));if(n!==v.hash)throw new Error(`Chunk hash does not match file hash: ${n}, expected: ${v.hash}`);const c=De(s,20,v.indexBytes);if(c<0||c>=v.totalChunks)throw new Error(`Invalid chunk index: ${c}`);return{index:c,data:s.slice(20+v.indexBytes)}}async function Xe(l){try{const v=[];for(let u=0;u<l.totalChunks;u++){if(l.chunks[u]===void 0)return{success:!1,error:`Missing chunk: ${u}`};v.push(l.chunks[u])}const s=v.reduce((u,D)=>u+D.length,0),n=new Uint8Array(s);let c=0;for(const u of v)n.set(u,c),c+=u.length;const d=await Te(n),t=re(d);if(t!==l.hash)return{success:!1,error:`Hash mismatch. Expected: ${l.hash}, Got: ${t}`};const p=new Blob([n]),h=URL.createObjectURL(p);return{success:!0,fileData:n,downloadUrl:h}}catch(v){return{success:!1,error:v instanceof Error?v.message:"Unknown error"}}}function Ye(l){const v=[];for(let s=0;s<l.totalChunks;s++)l.chunks[s]===void 0&&v.push(s);return v}function Ze(l){return l.receivedCount===l.totalChunks}function et(l,v){const s=document.createElement("a");s.href=l,s.download=v||"fichier_recu",document.body.appendChild(s),s.click(),document.body.removeChild(s)}var tt=m('<button class="primary svelte-l4z3uq">üì∑ Start Scanning</button>'),st=m('<button class="danger svelte-l4z3uq">‚èπ Stop Scanning</button>'),at=m('<div class="scanner-view svelte-l4z3uq"><video autoplay playsinline="" class="svelte-l4z3uq"></video> <canvas style="display:none;"></canvas> <div class="scanner-overlay svelte-l4z3uq"><div class="scanner-frame svelte-l4z3uq"></div></div></div>',2),rt=m("<div></div>"),nt=m('<div class="success-message svelte-l4z3uq">‚úì All chunks have been received!</div>'),lt=m('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">2. Reception Progress</h2> <div class="file-info"><p class="svelte-l4z3uq"><strong>Fichier:</strong> </p> <p class="svelte-l4z3uq"><strong>Hash:</strong> <code class="svelte-l4z3uq"> </code></p></div> <div class="progress-section svelte-l4z3uq"><p class="progress-text svelte-l4z3uq"> </p> <div class="chunks-grid svelte-l4z3uq"></div></div> <div class="stats svelte-l4z3uq"><div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Total scanned:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Duplicates:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Errors:</span> <span class="stat-value svelte-l4z3uq"> </span></div></div> <!></div>'),ot=m('<div class="recovery-section svelte-l4z3uq"><p class="info svelte-l4z3uq"><strong> </strong> <!></p> <div class="qr-display svelte-l4z3uq"><img alt="QR Code de r√©cup√©ration" class="svelte-l4z3uq"/> <p class="qr-caption svelte-l4z3uq">Scan this QR with the sender page to retransmit missing chunks</p></div></div>'),it=m(`<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">3. Missing chunks recovery</h2> <p class="svelte-l4z3uq">If chunks are missing, generate a recovery QR code to scan with the
          sender.</p> <button class="svelte-l4z3uq">üîÑ Generate Recovery QR</button> <!></div>`),ct=m('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">4. Download file</h2> <button class="download-button svelte-l4z3uq"> </button></div>'),vt=m('<main class="svelte-l4z3uq"><header class="card svelte-l4z3uq"><h1 class="svelte-l4z3uq">üì• QR Code Receiver</h1> <div class="controls svelte-l4z3uq"><!> <button class="secondary svelte-l4z3uq">üîÑ Reset</button></div></header> <section class="main-content svelte-l4z3uq"><!> <!></section> <footer class="card svelte-l4z3uq"><!> <!></footer></main>');function ut(l,v){$e(v,!0);let s,n,c,d=R(!1),t=R(null),p=R(""),h=R(""),u=R(J([])),D=R(J(Date.now())),y=R(J({totalScanned:0,duplicates:0,errors:0})),A=Qe(()=>e(t)!==null&&Ze(e(t)));async function ne(){if(f(d,!0),await Ee(),!s){alert("Video element not ready. Please try again."),f(d,!1);return}if(n&&!c&&(c=se(n)),!c){alert("Canvas not ready. Please try again."),f(d,!1);return}try{await Me(s,{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}),requestAnimationFrame(M)}catch(a){console.error("Camera access error:",a),alert("Unable to access camera. Please allow camera access."),f(d,!1)}}function $(){f(d,!1),s&&Pe(s)}async function M(){if(!e(d)||!c||!s||!n)return;const a=await Ge(s,n,c);if(a.length>0)for(const r of a)r?.data.length>0&&le(r);requestAnimationFrame(M)}function le(a){try{f(t,Ie(a),!0),console.log("File info received:",e(t));return}catch{}e(y).totalScanned++;try{if(!e(t)){console.log("Waiting for file info QR code first...");return}const r=Ke(a,e(t));if(e(t).chunks[r.index]!==void 0){e(y).duplicates++;return}e(t).receivedCount++,e(t).chunks[r.index]=r.data,f(D,Date.now(),!0),console.log(`Received chunk ${r.index+1}/${e(t).totalChunks} (${r.data.length} bytes)`),e(A)&&($(),oe())}catch(r){e(y).errors++,console.error("Error processing QR code:",r)}}async function oe(){if(!e(t))return;console.log("Assembling file...");const a=await Xe(e(t));if(!a.success){alert(`‚ö† Error: ${a.error}`),console.error("Assembly error:",a.error);return}f(h,a.downloadUrl,!0),console.log("‚úì File assembled successfully!")}async function ie(){if(e(t)){if(f(u,Ye(e(t)),!0),e(u).length===0){alert("All chunks have been received!");return}try{const a=new Uint8Array(20);for(let r=0;r<20;r++)a[r]=parseInt(e(t).hash.slice(r*2,r*2+2),16);f(p,await je(a,e(u)),!0)}catch(a){console.error("Erreur lors de la g√©n√©ration du QR de r√©cup√©ration:",a)}}}function ce(){!e(h)||!e(t)||et(e(h),e(t).name)}function ve(){$(),f(t,null),f(p,""),f(h,""),f(u,[],!0),f(y,{totalScanned:0,duplicates:0,errors:0},!0),e(h)&&URL.revokeObjectURL(e(h))}Ue(()=>(n&&(c=se(n)),()=>{$(),e(h)&&URL.revokeObjectURL(e(h))}));var P=vt(),G=o(P),ue=i(o(G),2),V=o(ue);{var de=a=>{var r=tt();r.__click=ne,g(a,r)},he=a=>{var r=st();r.__click=$,g(a,r)};z(V,a=>{e(d)?a(he,!1):a(de)})}var fe=i(V,2);fe.__click=ve;var W=i(G,2),I=o(W);{var pe=a=>{var r=at(),_=o(r);ee(_,b=>s=b,()=>s);var q=i(_,2);ee(q,b=>n=b,()=>n),g(a,r)};z(I,a=>{e(d)&&a(pe)})}var _e=i(I,2);{var ge=a=>{var r=lt(),_=i(o(r),2),q=o(_),b=i(o(q)),x=i(q,2),U=i(o(x),2),Q=o(U),S=i(_,2),F=o(S),E=o(F),T=i(F,2);Le(T,21,()=>Array(e(t).totalChunks),Je,(w,X,Y)=>{var j=rt();let Z;B(()=>{Z=We(j,1,"chunk-box svelte-l4z3uq",null,Z,{received:e(t).chunks[Y]!==void 0}),te(j,"title",`Chunk ${Y+1}/${e(t).totalChunks??""}`)}),g(w,j)});var H=i(S,2),N=o(H),L=i(o(N),2),C=o(L),O=i(N,2),ye=i(o(O),2),be=o(ye),Ce=i(O,2),we=i(o(Ce),2),Re=o(we),xe=i(H,2);{var Se=w=>{var X=nt();g(w,X)};z(xe,w=>{e(A)&&w(Se)})}B(w=>{k(b,` ${e(t).name??""}`),k(Q,e(t).hash),k(E,`${e(t).receivedCount??""} / ${e(t).totalChunks??""} chunks received (${w??""}%)`),k(C,e(y).totalScanned),k(be,e(y).duplicates),k(Re,e(y).errors)},[()=>(e(t).receivedCount/e(t).totalChunks*100).toFixed(1)]),g(a,r)};z(_e,a=>{e(t)&&a(ge)})}var me=i(W,2),K=o(me);{var ke=a=>{var r=it(),_=i(o(r),4);_.__click=ie;var q=i(_,2);{var b=x=>{var U=ot(),Q=o(U),S=o(Q),F=o(S),E=i(S),T=i(E);{var H=C=>{var O=He("...");g(C,O)};z(T,C=>{e(u).length>10&&C(H)})}var N=i(Q,2),L=o(N);B(C=>{k(F,e(u).length),k(E,` missing chunk(s):
              ${C??""} `),te(L,"src",e(p))},[()=>e(u).slice(0,10).join(", ")]),g(x,U)};z(q,x=>{e(p)&&x(b)})}g(a,r)};z(K,a=>{e(t)&&!e(A)&&a(ke)})}var qe=i(K,2);{var ze=a=>{var r=ct(),_=i(o(r),2);_.__click=ce;var q=o(_);B(()=>k(q,`üíæ Download ${e(t).name??""}`)),g(a,r)};z(qe,a=>{e(A)&&e(h)&&a(ze)})}g(l,P),Fe()}Ae(["click"]);Ne(ut,{target:document.body});
