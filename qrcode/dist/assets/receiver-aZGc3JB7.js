import{j as Ae,k as $e,n as R,o as Ue,q as Fe,y as e,f as _,v as o,w as l,H as Qe,a as m,A as Ee,B as p,x as H,C as q,h as Ie,G as Ne,I as Oe,m as He}from"./disclose-version-CVD8pSWN.js";import{n as Be,o as Te,b as ae,p as Je,q as Le,i as z,d as Z,e as je,r as De,a as ee,c as Pe,f as se,h as Me,m as Ge,l as Ve}from"./scannerService-CEV5QOf7.js";const te=[...` 	
\r\f¬†\v\uFEFF`];function We(d,r,a){var n=""+d;if(a){for(var c in a)if(a[c])n=n?n+" "+c:c;else if(n.length)for(var u=c.length,s=0;(s=n.indexOf(c,s))>=0;){var f=s+u;(s===0||te.includes(n[s-1]))&&(f===n.length||te.includes(n[f]))?n=(s===0?"":n.substring(0,s))+n.substring(f+1):s=f}}return n===""?null:n}function Ke(d,r,a,n,c,u){var s=d.__className;if(s!==a||s===void 0){var f=We(a,n,u);f==null?d.removeAttribute("class"):d.className=f,d.__className=a}else if(u&&c!==u)for(var h in u){var v=!!u[h];(c==null||v!==!!c[h])&&d.classList.toggle(h,v)}return u}function Xe(d){if(d.data[0]!==123)throw new Error("Data is not JSON");const a=JSON.parse(d.decode());if(a.type!=="fileInfo")throw new Error(`Unknown JSON QR code type: ${a.type}`);const n=Be(a.totalChunks);return{hash:a.fileHash,name:a.fileName,size:a.fileSize,totalChunks:a.totalChunks,indexBytes:n}}function Ye(d,r){let a;d.data instanceof Int8Array?a=Je(d.data):a=new Uint8Array(d.data);const n=ae(a.slice(0,20));if(n!==r.hash)throw new Error(`Chunk hash does not match file hash: ${n}, expected: ${r.hash}`);const c=Le(a,20,r.indexBytes);if(c<0||c>=r.totalChunks)throw new Error(`Invalid chunk index: ${c}`);return{index:c,data:a.slice(20+r.indexBytes)}}class Ze{constructor(r){this.info=r,this.info=r,this.chunks=new Array(r.totalChunks),this.stats={total:0,count:0,duplicates:0,errors:0}}hasChunks(r){return this.chunks[r]!==void 0}isInfoEquals(r){return JSON.stringify(this.info)===JSON.stringify(r)}addChunk(r){if(this.chunks[r.index]!==void 0){this.stats.duplicates++;return}this.stats.count++,this.chunks[r.index]=r.data,console.log(`Add chunk ${r.index+1}/${this.info.totalChunks} (${r.data.length} bytes)`)}getProgressPercent(){return this.stats.count/this.info.totalChunks*100}findMissingChunks(){const r=[];for(let a=0;a<this.info.totalChunks;a++)this.chunks[a]===void 0&&r.push(a);return r}isFileComplete(){return this.stats.count===this.info.totalChunks}async assembleFile(){try{const r=[];for(let v=0;v<this.info.totalChunks;v++){if(this.chunks[v]===void 0)return{success:!1,error:`Missing chunk: ${v}`};r.push(this.chunks[v])}const a=r.reduce((v,k)=>v+k.length,0),n=new Uint8Array(a);let c=0;for(const v of r)n.set(v,c),c+=v.length;const u=await Te(n),s=ae(u);if(s!==this.info.hash)return{success:!1,error:`Hash mismatch. Expected: ${this.info.hash}, Got: ${s}`};const f=new Blob([n]),h=URL.createObjectURL(f);return{success:!0,fileData:n,downloadUrl:h}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}}var es=_('<button class="primary svelte-l4z3uq">üì∑ Start Scanning</button>'),ss=_('<button class="danger svelte-l4z3uq">‚èπ Stop Scanning</button>'),ts=_('<div class="scanner-view svelte-l4z3uq"><video autoplay playsinline="" class="svelte-l4z3uq"></video> <canvas style="display:none;"></canvas> <div class="scanner-overlay svelte-l4z3uq"><div class="scanner-frame svelte-l4z3uq"></div></div></div>',2),as=_("<div></div>"),rs=_('<div class="success-message svelte-l4z3uq">‚úì All chunks have been received!</div>'),ns=_('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">2. Reception Progress</h2> <div class="file-info"><p class="svelte-l4z3uq"><strong>Fichier:</strong> </p> <p class="svelte-l4z3uq"><strong>Hash:</strong> <code class="svelte-l4z3uq"> </code></p></div> <div class="progress-section svelte-l4z3uq"><p class="progress-text svelte-l4z3uq"> </p> <div class="chunks-grid svelte-l4z3uq"></div></div> <div class="stats svelte-l4z3uq"><div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Total scanned:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Duplicates:</span> <span class="stat-value svelte-l4z3uq"> </span></div> <div class="stat-item svelte-l4z3uq"><span class="stat-label svelte-l4z3uq">Errors:</span> <span class="stat-value svelte-l4z3uq"> </span></div></div> <!></div>'),is=_('<div class="recovery-section svelte-l4z3uq"><p class="info svelte-l4z3uq"><strong> </strong> <!></p> <div class="qr-display svelte-l4z3uq"><img alt="QR Code de r√©cup√©ration" class="svelte-l4z3uq"/> <p class="qr-caption svelte-l4z3uq">Scan this QR with the sender page to retransmit missing chunks</p></div></div>'),ls=_(`<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">3. Missing chunks recovery</h2> <p class="svelte-l4z3uq">If chunks are missing, generate a recovery QR code to scan with the
          sender.</p> <button class="svelte-l4z3uq">üîÑ Generate Recovery QR</button> <!></div>`),os=_('<div class="card svelte-l4z3uq"><h2 class="svelte-l4z3uq">4. Download file</h2> <button class="download-button svelte-l4z3uq"> </button></div>'),cs=_('<main class="svelte-l4z3uq"><header class="card svelte-l4z3uq"><h1 class="svelte-l4z3uq">üì• QR Code Receiver</h1> <div class="controls svelte-l4z3uq"><!> <button class="secondary svelte-l4z3uq">üîÑ Reset</button></div></header> <section class="main-content svelte-l4z3uq"><!> <!></section> <footer class="card svelte-l4z3uq"><!> <!></footer></main>');function vs(d,r){$e(r,!0);let a,n,c,u=R(!1),s=R(null),f=R(""),h=R(""),v=R(Ue([])),k=R(0);function B(){Oe(k)}let A=Qe(()=>e(s)?.isFileComplete()??!1);async function re(){if(p(u,!0),await Ie(),!a){alert("Video element not ready. Please try again."),p(u,!1);return}if(n&&!c&&(c=se(n)),!c){alert("Canvas not ready. Please try again."),p(u,!1);return}try{await Me(a,{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}),requestAnimationFrame(j)}catch(t){console.error("Camera access error:",t),alert("Unable to access camera. Please allow camera access."),p(u,!1)}}function $(){p(u,!1),a&&Ge(a)}async function j(){if(!e(u)||!c||!a||!n)return;const t=await Ve(a,n,c);if(t.length>0)for(const i of t)i?.data.length>0&&ne(i);requestAnimationFrame(j)}function ne(t){try{const i=Xe(t);e(s)?.isInfoEquals(i)||(p(s,new Ze(i),!0),console.log("Initialized file reception:",e(s).info));return}catch{}if(!e(s)){console.log("Waiting for file info QR code first...");return}e(s).stats.total++,B();try{const i=Ye(t,e(s).info);e(s).addChunk(i),B(),e(A)&&($(),ie())}catch(i){e(s).stats.errors++,B(),console.error("Error processing QR code:",i)}}async function ie(){if(!e(s))return;console.log("Assembling file...");const t=await e(s).assembleFile();if(!t.success){alert(`‚ö† Error: ${t.error}`),console.error("Assembly error:",t.error);return}p(h,t.downloadUrl,!0),console.log("‚úì File assembled successfully!")}async function le(){if(e(s)){if(p(v,e(s).findMissingChunks(),!0),e(v).length===0){alert("All chunks have been received!");return}try{const t=new Uint8Array(20);for(let i=0;i<20;i++)t[i]=parseInt(e(s).info.hash.slice(i*2,i*2+2),16);p(f,await De(t,e(v)),!0)}catch(t){console.error("Erreur lors de la g√©n√©ration du QR de r√©cup√©ration:",t)}}}function oe(){if(!e(h)||!e(s))return;const t=document.createElement("a");t.href=e(h),t.download=e(s).info.name||"fichier_recu",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function ce(){$(),p(s,null),p(f,""),p(h,""),p(v,[],!0),e(h)&&URL.revokeObjectURL(e(h))}Fe(()=>(n&&(c=se(n)),()=>{$(),e(h)&&URL.revokeObjectURL(e(h))}));var D=cs(),P=l(D),ve=o(l(P),2),M=l(ve);{var ue=t=>{var i=es();i.__click=re,m(t,i)},de=t=>{var i=ss();i.__click=$,m(t,i)};z(M,t=>{e(u)?t(de,!1):t(ue)})}var he=o(M,2);he.__click=ce;var G=o(P,2),V=l(G);{var fe=t=>{var i=ts(),g=l(i);Z(g,b=>a=b,()=>a);var y=o(g,2);Z(y,b=>n=b,()=>n),m(t,i)};z(V,t=>{e(u)&&t(fe)})}var pe=o(V,2);{var ge=t=>{var i=ns(),g=o(l(i),2),y=l(g),b=o(l(y)),x=o(y,2),U=o(l(x),2),F=l(U),S=o(g,2),Q=l(S),E=l(Q),T=o(Q,2);je(T,21,()=>Array(e(s).info.totalChunks),Pe,(w,K,X)=>{var L=as();let Y;H(Se=>{Y=Ke(L,1,"chunk-box svelte-l4z3uq",null,Y,Se),ee(L,"title",`Chunk ${X+1}/${e(s).info.totalChunks??""}`)},[()=>({received:e(k)&&e(s).hasChunks(X)})]),m(w,L)});var I=o(S,2),N=l(I),J=o(l(N),2),C=l(J),O=o(N,2),ye=o(l(O),2),ze=l(ye),be=o(O,2),Ce=o(l(be),2),we=l(Ce),Re=o(I,2);{var xe=w=>{var K=rs();m(w,K)};z(Re,w=>{e(A)&&w(xe)})}H(w=>{q(b,` ${e(s).info.name??""}`),q(F,e(s).info.hash),q(E,`${(e(k)&&e(s).stats.count)??""} / ${e(s).info.totalChunks??""}
            chunks received (${w??""}%)`),q(C,e(k)&&e(s).stats.total),q(ze,e(k)&&e(s).stats.duplicates),q(we,e(k)&&e(s).stats.errors)},[()=>((e(k)&&e(s).stats.count/e(s).info.totalChunks)*100).toFixed(1)]),m(t,i)};z(pe,t=>{e(s)&&t(ge)})}var me=o(G,2),W=l(me);{var _e=t=>{var i=ls(),g=o(l(i),4);g.__click=le;var y=o(g,2);{var b=x=>{var U=is(),F=l(U),S=l(F),Q=l(S),E=o(S),T=o(E);{var I=C=>{var O=Ne("...");m(C,O)};z(T,C=>{e(v).length>10&&C(I)})}var N=o(F,2),J=l(N);H(C=>{q(Q,e(v).length),q(E,` missing chunk(s):
              ${C??""} `),ee(J,"src",e(f))},[()=>e(v).slice(0,10).join(", ")]),m(x,U)};z(y,x=>{e(f)&&x(b)})}m(t,i)};z(W,t=>{e(s)&&!e(A)&&t(_e)})}var ke=o(W,2);{var qe=t=>{var i=os(),g=o(l(i),2);g.__click=oe;var y=l(g);H(()=>q(y,`üíæ Download ${e(s).info.name??""}`)),m(t,i)};z(ke,t=>{e(A)&&e(h)&&t(qe)})}m(d,D),Ee()}Ae(["click"]);He(vs,{target:document.body});
